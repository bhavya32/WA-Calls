const baileys = require('@adiwajshing/baileys');
var atob = require('atob')
var crypto = require("crypto")
var btoa = require('btoa')
const fs = require('fs');
const wavoip = require('wavoip')
client = new baileys.WAConnection()
fs.existsSync("./tokens/client.json") && client.loadAuthInfo("./tokens/client.json")
client.on('open', open => {
    const authInfo = client.base64EncodedAuthInfo()
    fs.writeFileSync("./tokens/client.json", JSON.stringify(authInfo, null, '\t'))
})
client.logger.level = 'warn'
client.browserDescription = ['Windows', 'electron', '10'];
client.connect()
const log_cb = (event) => console.log('log', wavoip.eventToStr(event))
const test = (event) => console.log('log', event)
const event_cb = (event, eventData) => console.log("got event: " + wavoip.eventToStr(event))
const signaling_data_cb = (a, b, c) => {
	if(c[0]=="accept"){
	   var tag = generate_tag()
	   var jsjs = ["action","call",["call",{"from":client.user.jid,"to":b,"id":tag},[["accept",{"call-id":a,"call-creator":b,"device":"web"},[["audio",{"enc":"opus","rate":"16000"},null],["te",{"priority":"2"},array2b64(c[2][1][2])],["net",{"medium":"2"},null],["encopt",{"keygen":"2"},null],["capability",{"ver":"1"},"AQT3C84D"]]]]]]		
	   client.send(`${tag},,${JSON.stringify(jsjs)}`)
	   var res = client.waitForMessage(tag, true).then((json) => {
		   
		   if (json.payload){
			   var number = json.payload[2][0][1]["call-creator"]
	           var x = json.payload
	           var voip_set = [120,156,125,84,219,114,227,32,12,253,23,63,231,193,205,182,123,233,207,104,48,200,14,13,183,130,136,147,233,244,223,87,194,184,77,59,59,251,102,208,225,72,58,62,210,219,160,80,15,207,111,131,143,6,135,231,225,56,28,6,229,150,152,45,157,60,159,57,10,151,31,195,251,97,152,86,20,92,45,8,170,26,27,33,41,125,70,130,172,72,30,62,8,198,160,110,52,111,252,229,212,13,102,225,30,70,9,97,216,67,129,223,181,7,135,97,206,202,35,248,194,199,159,35,159,117,244,201,225,213,210,141,111,158,228,98,202,59,129,13,150,160,23,129,65,77,14,13,204,49,195,197,26,140,80,211,146,149,249,40,36,38,178,49,20,193,22,212,53,35,20,170,129,51,45,176,114,107,216,243,127,143,37,149,203,30,139,169,22,144,110,87,156,50,105,152,107,208,157,116,160,92,145,33,46,234,115,207,207,130,97,32,37,128,86,240,97,120,153,64,58,5,99,139,86,217,128,142,53,16,204,246,218,249,57,110,195,164,130,17,149,64,173,42,227,39,179,77,140,15,179,93,58,24,131,73,4,41,58,103,195,2,100,61,198,74,92,114,211,247,97,28,27,68,52,145,114,32,6,174,154,229,23,197,53,4,92,226,7,77,195,212,208,42,23,245,88,53,141,115,117,32,170,127,69,149,146,53,24,244,245,250,245,126,209,202,185,59,238,187,158,58,98,171,22,47,40,13,255,63,73,183,146,93,150,219,36,106,5,164,53,230,51,120,170,157,183,43,98,16,69,147,196,166,202,30,156,42,59,145,84,131,121,215,132,47,255,136,26,27,111,216,40,87,200,180,195,239,2,94,93,161,224,43,100,124,109,42,126,141,190,88,34,230,245,213,145,77,206,98,222,167,163,65,54,59,67,156,103,23,149,249,228,134,116,230,145,192,152,13,191,77,90,178,62,53,98,231,226,42,255,148,13,151,69,23,85,228,23,216,248,90,177,34,156,241,182,91,55,111,227,104,195,156,82,231,229,66,183,6,142,79,99,63,111,193,99,51,225,10,70,145,98,175,170,5,97,178,180,79,228,227,56,118,35,158,108,161,214,174,54,51,92,148,171,18,255,117,252,125,188,11,27,76,177,240,136,237,225,163,204,159,88,179,207,235,157,199,50,250,9,232,148,35,145,248,241,223,202,50,111,91,2,146,105,252,166,173,108,24,6,21,225,125,108,77,183,177,118,92,120,208,55,30,102,110,8,37,3,150,83,116,230,195,227,242,147,11,41,191,11,147,184,132,221,219,125,129,181,93,65,40,246,144,85,227,229,78,223,11,191,75,110,10,177,161,40,59,121,32,83,179,9,127,73,87,94,3,55,249,171,92,127,209,217,38,98,11,19,156,63,124,254,254,254,23,73,73,202,170]
	           obj = {
				peer_jid: number.split("@")[0]+"@s.whatsapp.net",
                type: "accept",
				error: 0,
				ack: ["ack",null,[["accept",{"call-id":x[2][0][1]["call-id"],"call-creator":number,"device":"web"},[["audio",{"enc":"opus","rate":16000},null],["te",{"priority":2},b64toarray(json.payload[2][0][2][1][2])],["net",{"medium":2},null],["encopt",{"keygen":2},null],["capability",{"ver":1},[1,4,247,11,206,3]]]],["rte",null,b64toarray(json.payload[2][1][2])],["voip_settings",{"uncompressed":1},b64toarray(json.payload[2][2][2])],["relay",{"peer_pid":1,"attribute_padding":0,"transaction-id":0},[["token",null,b64toarray(json.payload[2][3][2][0][2])],["te",null,b64toarray(json.payload[2][3][2][1][2])],["te",null,b64toarray(json.payload[2][3][2][2][2])],["te",null,b64toarray(json.payload[2][3][2][3][2])],["te",null,b64toarray(json.payload[2][3][2][4][2])]]]]]
			   }
			 wavoip.handleIncomingSignalingAck(obj)
	        }
		   })
	   jsjs = ["query",{"type":"call","call-id":a,"kind":"accept","epoch":client.msgCount.toString()},null]
		client.sendBinary(jsjs, [{"metricName":"QUERY_CALL"},{"metric":38}], undefined,false)
	}else if(c[0]=="transport"){
		var tag = Date.now()
		var x = c
		console.log(client.user.jid)
		var payload = ["action","call",["call",{"from":client.user.jid,"to":b,"id":tag},[["transport",{"call-id":a,"call-creator":b},[["te",{"priority":x[2][0][1].priority},array2b64(x[2][0][2])],["net",{"medium":"2"},null]]]]]]
		client.send(`${tag},,${JSON.stringify(jsjs)}`)
	}else if(c[0]=="relaylatency"){
		var tag = Date.now()
		var x = c
		var payload = ["action","call",["call",{"from":client.user.jid,"to":b,"id":tag},[["relaylatency",{"call-id":a,"call-creator":b,"transaction-id":"0"},[["te",{"latency":x[2][0][1].latency},array2b64(x[2][0][2])]]]]]]
		client.send(`${tag},,${JSON.stringify(jsjs)}`)
	}else{
		console.log('voip signaling data: ', a , b, JSON.stringify(c))
	}
}
	
wavoip.cleanup()
wavoip.init("919876543210@s.whatsapp.net", false, true)
wavoip.getAVDevices((function(t){}))
wavoip.registerEventCallback(event_cb)
wavoip.registerSignalingXmppCallback(signaling_data_cb)
//wavoip.registerLoggingCallback(log_cb)
wavoip.setLogPath("D:\\ws\\voip_crash_log.txt")
wavoip.getAVDevices((function(t){}))
wavoip.updateNetworkMedium(2, 0)
wavoip.updateAudioVideoSwitch(true)
client.on('CB:Call', async json => {
	let number = json[1]['from'];
        let isOffer = json[1]["type"] == "offer";

        if (number && isOffer && json[1]["data"]) {
			var time = '"' + Date.now() + '"'
			var obj = {elapsed_msec: undefined,
						 epoch_msec: time*1000,
						 is_offline: undefined,
						 payload:["offer", {'call-creator': number, 'call-id': json[1]['id'], 't': time}, [["audio",{"rate":16000,"enc":"opus"},null],["audio",{"rate":8000,"enc":"opus"},null],["capability",{"ver":1},[1,4,247,11,206,2]],["enc",{"v":2,"type":"msg"},[53,55,133,120,27,107,64,0,77,19,205,133,163,53,107,234,0,134,65,239,78,171,216,150,190,31,31,244,155,105,136,102]],["encopt",{"keygen":2},null],["net",{"medium":3},null],["rte",null,[122,160,14,39,132,36]],["uploadfieldstat",null,null],["relay",{"peer_pid":1,"attribute_padding":1},[["token",null,[8,1,0,159,177,79,122,236,46,151,137,207,78,160,17,168,185,147,200,193,170,77,252,11,38,26,16,119,39,107,77,61,174,187,97,48,5,137,38,129,86,81,206,78,120,140,11,74,87,172,109,35,13,249,134,123,190,218,85,191,138,240,154,245,238,143,148,3,147,166,236,45,39,13,15,85,169,19,79,12,212,34,53,98,84,176,62,17,2,151,64,170,246,59,248,211,4,191,7,201,12,175]],["token",{"id":1},[8,2,0,159,177,79,122,236,46,151,137,207,78,160,17,168,185,147,51,68,86,138,239,43,159,7,113,191,72,199,176,53,226,132,59,251,61,133,211,238,115,131,228,219,135,183,252,252,117,61,232,8,107,216,175,116,136,249,1,170,109,17,14,41,221,252,14,102,242,120,101,64,245,101,5,12,136,158,46,66,237,33,5,9,35,38,255,125,178,186,7,202,177,53,250,48,179,6,99,104,177,68]],["key",null,[88,51,103,109,118,98,103,76,114,65,71,98,52,97,107,71,82,56,65,57,50,103,61,61]],["te2",{"relay_id":0,"token_id":1},[116,119,74,98,13,150]],["te2",{"relay_id":0,"token_id":1},[36,4,168,0,0,6,0,144,250,206,176,12,51,51,77,240,13,150]],["te2",{"relay_id":1},[157,240,198,62,13,150]],["te2",{"relay_id":1},[42,3,40,128,242,68,0,192,250,206,176,12,0,0,1,119,13,150]],["te2",{"relay_id":2},[157,240,16,51,13,150]],["te2",{"relay_id":2},[42,3,40,128,242,47,0,195,250,206,176,12,0,0,1,119,13,150]],["te2",{"relay_id":3},[157,240,228,62,13,150]],["te2",{"relay_id":3},[42,3,40,128,242,104,0,192,250,206,176,12,0,0,1,119,13,150]],["te2",{"relay_id":4},[157,240,235,62,13,150]],["te2",{"relay_id":4},[42,3,40,128,242,12,3,192,250,206,176,12,0,0,1,119,13,150]]]],["voip_settings",{"uncompressed":1},[123,34,97,101,99,34,58,123,34,111,102,102,115,101,116,34,58,34,48,34,44,34,109,111,100,101,34,58,34,50,34,44,34,101,99,104,111,95,100,101,116,101,99,116,111,114,95,109,111,100,101,34,58,34,52,34,44,34,101,99,104,111,95,100,101,116,101,99,116,111,114,95,105,109,112,108,34,58,34,50,34,44,34,101,99,95,116,104,114,101,115,104,111,108,100,34,58,34,53,48,34,44,34,101,99,95,111,102,102,95,116,104,114,101,115,104,111,108,100,34,58,34,52,48,34,44,34,100,105,115,97,98,108,101,95,97,103,99,34,58,34,49,34,44,34,97,108,103,111,114,105,116,104,109,34,58,34,97,101,99,109,34,44,34,97,101,99,109,95,97,100,97,112,116,95,115,116,101,112,95,115,105,122,101,34,58,34,50,34,125,44,34,97,103,99,34,58,123,34,109,111,100,101,34,58,34,48,34,44,34,108,105,109,105,116,101,114,101,110,97,98,108,101,34,58,34,49,34,44,34,99,111,109,112,114,101,115,115,105,111,110,103,97,105,110,34,58,34,57,34,44,34,116,97,114,103,101,116,108,101,118,101,108,34,58,34,49,34,125,44,34,98,119,101,34,58,123,34,117,115,101,95,97,117,100,105,111,95,112,97,99,107,101,116,95,114,97,116,101,34,58,34,49,34,44,34,100,101,108,97,121,95,98,97,115,101,100,95,98,119,101,95,116,114,101,110,100,108,105,110,101,95,102,105,108,116,101,114,95,101,110,97,98,108,101,100,34,58,34,49,34,44,34,100,101,108,97,121,95,98,97,115,101,100,95,98,119,101,95,98,105,116,114,97,116,101,95,101,115,116,105,109,97,116,111,114,95,101,110,97,98,108,101,100,34,58,34,49,34,44,34,98,119,101,95,105,109,112,108,34,58,34,53,34,125,44,34,100,101,99,111,100,101,34,58,123,34,100,101,108,97,121,95,102,101,99,34,58,34,48,34,125,44,34,101,110,99,111,100,101,34,58,123,34,110,97,99,107,34,58,34,49,34,44,34,102,114,97,109,101,95,109,115,34,58,34,54,48,34,44,34,99,111,109,112,108,101,120,105,116,121,34,58,34,53,34,44,34,99,98,114,34,58,34,48,34,125,44,34,105,110,105,116,95,98,119,101,34,58,123,34,115,116,111,112,95,112,114,111,98,105,110,103,95,98,101,102,111,114,101,95,97,99,99,101,112,116,95,115,101,110,100,34,58,34,49,34,44,34,115,107,105,112,95,102,111,114,99,101,100,95,115,105,103,110,97,108,105,110,103,34,58,34,49,34,44,34,108,97,122,121,95,115,101,110,100,95,112,114,111,98,105,110,103,95,114,101,113,34,58,34,49,34,44,34,101,110,97,98,108,101,100,95,102,111,114,95,118,105,100,101,111,95,117,112,103,114,97,100,101,34,58,34,49,34,44,34,101,110,97,98,108,101,95,111,110,101,95,115,105,100,101,95,109,111,100,101,34,58,34,49,34,44,34,101,110,97,98,108,101,95,100,111,119,110,108,105,110,107,95,114,101,108,97,121,95,108,97,116,101,110,99,121,95,111,110,108,121,34,58,34,49,34,44,34,99,97,112,95,101,115,116,105,109,97,116,101,100,95,98,105,116,114,97,116,101,34,58,34,49,34,125,44,34,110,115,34,58,123,34,109,111,100,101,34,58,34,49,34,125,44,34,111,112,116,105,111,110,115,34,58,123,34,117,115,101,95,100,105,115,111,114,100,101,114,95,112,114,101,102,101,116,99,104,105,110,103,95,116,105,109,101,114,34,58,34,49,34,44,34,117,115,101,95,99,111,114,114,101,99,116,95,111,114,100,101,114,95,102,111,114,95,104,109,97,99,95,115,104,97,49,34,58,34,49,34,44,34,115,112,97,109,95,99,97,108,108,95,116,104,114,101,115,104,111,108,100,95,115,101,99,111,110,100,115,34,58,34,53,53,34,44,34,115,104,111,119,95,110,111,116,105,102,105,99,97,116,105,111,110,95,102,111,114,95,115,112,97,109,95,99,97,108,108,34,58,34,49,34,44,34,115,104,111,117,108,100,95,109,111,110,105,116,111,114,95,97,117,100,105,111,95,104,101,97,108,116,104,34,58,34,49,34,44,34,115,101,99,117,114,101,95,115,116,117,110,95,109,115,103,95,119,114,105,116,101,34,58,34,49,34,44,34,115,101,99,117,114,101,95,115,116,117,110,95,109,115,103,95,112,97,114,115,101,34,58,34,49,34,44,34,114,101,115,112,101,99,116,95,105,110,105,116,105,97,108,95,98,105,116,114,97,116,101,95,101,115,116,105,109,97,116,101,34,58,34,116,114,117,101,34,44,34,114,101,99,111,110,110,101,99,116,105,110,103,95,98,101,102,111,114,101,95,114,101,108,97,121,95,102,97,105,108,111,118,101,114,95,116,104,114,101,115,104,111,108,100,95,109,115,34,58,34,50,48,48,48,48,34,44,34,114,101,99,111,110,110,101,99,116,105,110,103,95,98,101,102,111,114,101,95,112,50,112,95,102,97,105,108,111,118,101,114,95,116,104,114,101,115,104,111,108,100,95,109,115,34,58,34,49,53,48,48,48,34,44,34,114,101,99,111,110,110,101,99,116,105,110,103,95,98,101,102,111,114,101,95,110,101,116,119,111,114,107,95,99,104,97,110,103,101,95,116,104,114,101,115,104,111,108,100,95,109,115,34,58,34,49,53,48,48,48,34,44,34,114,101,99,111,110,110,101,99,116,105,110,103,95,97,102,116,101,114,95,114,101,108,97,121,95,102,97,105,108,111,118,101,114,95,116,104,114,101,115,104,111,108,100,95,109,115,34,58,34,49,53,48,48,48,34,44,34,114,101,99,111,110,110,101,99,116,105,110,103,95,97,102,116,101,114,95,112,50,112,95,102,97,105,108,111,118,101,114,95,116,104,114,101,115,104,111,108,100,95,109,115,34,58,34,49,48,48,48,48,34,44,34,114,101,99,111,110,110,101,99,116,105,110,103,95,97,102,116,101,114,95,110,101,116,119,111,114,107,95,99,104,97,110,103,101,95,116,104,114,101,115,104,111,108,100,95,109,115,34,58,34,49,48,48,48,48,34,44,34,114,101,99,111,110,110,101,99,116,105,110,103,95,97,102,116,101,114,95,99,97,108,108,95,97,99,116,105,118,101,95,116,104,114,101,115,104,111,108,100,95,109,115,34,58,34,49,53,48,48,48,34,44,34,111,112,117,115,95,117,115,101,95,119,101,98,114,116,99,95,102,117,110,99,116,105,111,110,115,34,58,34,116,114,117,101,34,44,34,109,97,120,95,114,116,112,95,97,117,100,105,111,95,112,97,99,107,101,116,95,114,101,115,101,110,100,115,34,58,34,51,34,44,34,108,111,99,107,95,118,105,100,101,111,95,111,114,105,101,110,116,97,116,105,111,110,34,58,34,48,34,44,34,106,98,95,110,97,99,107,95,100,105,115,99,97,114,100,95,99,111,117,110,116,95,102,105,120,34,58,34,49,34,44,34,106,98,95,105,110,98,97,110,100,95,102,101,99,95,97,119,97,114,101,34,58,34,116,114,117,101,34,44,34,106,98,95,101,102,102,95,115,105,122,101,95,102,105,120,34,58,34,49,34,44,34,106,98,95,101,97,114,108,121,95,112,114,111,98,95,104,105,115,116,95,115,104,114,105,110,107,34,58,34,49,34,44,34,106,98,95,100,105,115,99,97,114,100,95,99,111,117,110,116,95,97,100,106,117,115,116,95,112,99,116,34,58,34,53,48,34,44,34,105,112,95,99,111,110,102,105,103,34,58,34,49,34,44,34,102,111,114,98,105,100,95,112,50,112,95,102,111,114,95,110,111,110,95,99,111,110,116,97,99,116,34,58,34,49,34,44,34,101,110,100,112,116,95,112,111,108,108,105,110,103,95,116,105,109,101,111,117,116,95,109,115,101,99,34,58,34,49,48,48,34,44,34,101,110,97,98,108,101,95,118,105,100,95,111,110,101,95,119,97,121,95,99,111,100,101,99,95,110,101,103,111,34,58,34,49,34,44,34,101,110,97,98,108,101,95,117,110,108,111,99,107,95,102,111,114,95,103,114,97,99,101,102,117,108,95,101,120,105,116,34,58,34,49,34,44,34,101,110,97,98,108,101,95,116,114,97,110,115,112,111,114,116,95,116,104,114,101,97,100,95,115,101,109,34,58,34,49,34,44,34,101,110,97,98,108,101,95,115,115,114,99,95,100,101,109,117,120,34,58,34,49,34,44,34,101,110,97,98,108,101,95,112,101,110,100,105,110,103,95,99,97,108,108,34,58,34,49,34,44,34,101,110,97,98,108,101,95,103,99,97,108,108,95,99,111,100,101,99,95,110,101,103,111,95,102,105,120,34,58,34,49,34,44,34,101,110,97,98,108,101,95,101,110,100,112,116,95,101,118,101,110,116,95,102,111,114,95,103,114,97,99,101,102,117,108,95,101,120,105,116,34,58,34,49,34,44,34,101,110,97,98,108,101,95,97,117,100,105,111,95,118,105,100,101,111,95,115,119,105,116,99,104,34,58,34,49,34,44,34,101,110,97,98,108,101,95,97,117,100,105,111,95,112,105,103,103,121,98,97,99,107,95,110,101,116,119,111,114,107,95,109,116,117,95,102,105,120,34,58,34,116,114,117,101,34,44,34,100,105,115,111,114,100,101,114,95,112,114,101,102,101,116,99,104,105,110,103,95,115,116,97,114,116,95,119,104,101,110,95,101,109,112,116,121,34,58,34,49,34,44,34,100,105,115,97,98,108,101,95,114,101,99,111,110,110,101,99,116,95,116,111,110,101,34,58,34,116,114,117,101,34,44,34,100,101,101,112,95,99,111,112,121,95,102,114,109,95,108,97,115,116,34,58,34,49,34,44,34,99,104,101,99,107,95,115,97,109,101,95,108,111,99,97,108,95,97,110,100,95,114,101,109,111,116,101,95,99,97,110,100,105,100,97,116,101,34,58,34,49,34,44,34,99,97,108,108,101,114,95,101,110,100,95,99,97,108,108,95,116,104,114,101,115,104,111,108,100,34,58,34,49,53,48,48,34,44,34,99,97,108,108,95,115,116,97,114,116,95,100,101,108,97,121,34,58,34,49,50,48,48,34,44,34,97,117,100,105,111,95,110,97,99,107,95,110,101,119,95,114,116,116,34,58,34,49,34,44,34,97,117,100,105,111,95,110,97,99,107,95,109,97,120,95,115,101,113,95,114,101,113,34,58,34,49,48,34,44,34,97,117,100,105,111,95,110,97,99,107,95,106,105,116,116,101,114,95,109,117,108,116,105,112,108,105,101,114,34,58,34,50,34,44,34,97,117,100,105,111,95,101,110,99,111,100,101,95,111,102,102,108,111,97,100,34,58,34,49,34,44,34,97,117,100,95,112,107,116,95,114,101,111,114,100,101,114,95,112,99,116,34,58,34,53,48,34,44,34,97,110,100,114,111,105,100,95,99,97,108,108,95,111,110,95,104,111,108,100,95,115,116,97,116,101,34,58,34,50,34,44,34,97,110,100,114,111,105,100,95,99,97,108,108,95,99,111,110,110,101,99,116,101,100,95,116,111,97,115,116,34,58,34,49,34,44,34,97,108,108,111,119,95,99,111,110,99,117,114,114,101,110,116,95,97,115,111,99,107,95,105,111,113,117,101,117,101,95,107,101,121,34,58,34,49,34,125,44,34,114,99,34,58,123,34,109,105,110,102,112,112,34,58,34,49,34,44,34,109,97,120,114,116,116,34,58,34,50,53,48,48,34,44,34,109,97,120,102,112,112,34,58,34,50,34,44,34,108,111,119,95,100,97,116,97,95,117,115,97,103,101,95,98,105,116,114,97,116,101,34,58,34,49,52,48,48,48,34,44,34,106,98,95,104,105,115,116,95,109,97,120,95,99,100,102,95,118,97,108,117,101,34,58,34,55,50,56,50,34,44,34,106,98,95,104,105,115,116,95,100,101,112,111,115,105,116,95,118,97,108,117,101,34,58,34,50,49,34,44,34,105,110,105,116,95,98,105,116,114,97,116,101,34,58,34,49,53,48,48,48,34,44,34,102,101,99,95,110,97,99,107,34,58,34,48,34,44,34,101,110,97,98,108,101,95,114,101,109,98,95,116,104,114,111,116,116,108,105,110,103,34,58,34,49,34,44,34,97,117,100,105,111,95,110,97,99,107,95,109,97,120,95,106,98,95,100,101,108,97,121,34,58,34,55,48,48,34,44,34,97,117,100,105,111,95,110,97,99,107,95,97,108,103,111,95,109,97,115,107,34,58,34,52,34,125,44,34,114,101,34,58,123,34,108,97,116,101,110,99,121,95,117,112,100,97,116,101,95,116,104,114,101,115,104,111,108,100,34,58,34,49,48,48,34,44,34,116,105,109,101,115,116,97,109,112,34,58,34,49,34,44,34,112,114,111,116,111,34,58,34,49,34,44,34,109,111,100,101,34,58,34,48,34,125,44,34,116,114,97,110,115,112,111,114,116,95,115,112,108,105,116,116,101,114,34,58,123,34,116,112,95,115,112,108,105,116,116,101,114,95,101,110,100,112,116,95,101,118,101,110,116,95,119,97,105,116,105,110,103,95,116,105,109,101,111,117,116,95,109,115,101,99,34,58,34,51,48,48,48,34,44,34,101,110,97,98,108,101,95,116,112,95,115,112,108,105,116,116,101,114,95,101,110,100,112,116,95,101,118,101,110,116,95,102,111,114,95,103,114,97,99,101,102,117,108,95,101,120,105,116,34,58,34,49,34,125,44,34,118,105,100,95,114,99,34,58,123,34,118,112,120,95,112,97,121,108,111,97,100,95,100,101,115,99,114,105,112,116,111,114,95,116,95,107,95,102,105,120,34,58,34,49,34,44,34,118,105,100,95,115,116,114,109,95,101,110,100,112,116,95,101,118,101,110,116,95,119,97,105,116,105,110,103,95,116,105,109,101,111,117,116,95,109,115,101,99,34,58,34,51,48,48,48,34,44,34,101,110,97,98,108,101,95,118,105,100,95,115,116,114,109,95,101,110,100,112,116,95,101,118,101,110,116,95,102,111,114,95,103,114,97,99,101,102,117,108,95,101,120,105,116,34,58,34,49,34,125,44,34,114,99,95,100,121,110,34,58,91,123,34,106,98,95,100,105,115,99,97,114,100,95,99,111,117,110,116,95,97,100,106,117,115,116,95,112,99,116,95,114,99,34,58,34,53,48,34,44,34,99,111,110,100,95,106,98,95,108,97,115,116,95,100,101,108,97,121,95,101,109,97,95,97,108,112,104,97,34,58,34,48,46,51,48,34,44,34,99,111,110,100,95,114,97,110,103,101,95,101,109,97,95,106,98,95,108,97,115,116,95,100,101,108,97,121,34,58,34,48,44,55,48,48,34,125,44,123,34,106,98,95,100,105,115,99,97,114,100,95,99,111,117,110,116,95,97,100,106,117,115,116,95,112,99,116,95,114,99,34,58,34,49,48,48,34,44,34,99,111,110,100,95,106,98,95,108,97,115,116,95,100,101,108,97,121,95,101,109,97,95,97,108,112,104,97,34,58,34,48,46,51,48,34,44,34,99,111,110,100,95,114,97,110,103,101,95,101,109,97,95,106,98,95,108,97,115,116,95,100,101,108,97,121,34,58,34,55,48,48,44,42,34,125,44,123,34,97,117,100,105,111,95,114,101,115,101,110,100,95,105,110,116,101,114,118,97,108,95,109,115,101,99,34,58,34,49,50,48,34,44,34,99,111,110,100,95,114,97,110,103,101,95,112,97,99,107,101,116,95,108,111,115,115,95,112,99,116,34,58,34,49,44,50,53,34,44,34,99,111,110,100,95,114,97,110,103,101,95,114,116,116,34,58,34,50,53,48,44,42,34,44,34,99,111,110,100,95,114,97,110,103,101,95,116,120,95,98,119,101,34,58,34,53,48,48,48,48,44,42,34,125,93,125]]]],
						 peer_app_version: "2.21.11",
						 peer_jid: number.split("@")[0]+"@s.whatsapp.net",
						 peer_platform: "smba"
			}
			wavoip.handleIncomingSignalingOffer(obj, false, 5)
			console.log("handleIncomingSignalingOffer");
			await new Promise(resolve => setTimeout(resolve, 2000));			
			wavoip.acceptCall(true, true)
		}else if (number && json[1]["type"] == "relaylatency") {
			var obj = {elapsed_msec: undefined,
						 epoch_msec: undefined,
						 is_offline: undefined,
						 payload:["relaylatency", {"call-creator": number, 'call-id': json[1]['id']}, [["te",{"latency":json[1]['data'][0][2][0][1]['latency']},b64toarray(json[1]['data'][0][2][0][2])]]],
						 peer_app_version: undefined,
						 peer_jid: number.split("@")[0]+"@s.whatsapp.net",
						 peer_platform: undefined
			}
			wavoip.handleIncomingSignalingMsg(obj)
        }else if (number && json[1]["type"] == "transport") {
			obj = {
				peer_jid:number.split("@")[0]+"@s.whatsapp.net",
				payload:["transport",{"call-creator":number,"call-id":json[1]['id']},[["te",{"priority":2},b64toarray(json[1]['data'][0][2][0][2])],["te",{"priority":1},b64toarray(json[1]['data'][0][2][1][2])],["net",{"medium":2},null]]]
				}
			wavoip.handleIncomingSignalingMsg(obj)
        }else if (number && json[1]["type"] == "receipt") {
			obj = {
				elapsed_msec: undefined,
                epoch_msec: undefined,
				is_offline: undefined,
				payload: ["accept",{"call-id":json[1].data[1]["call-id"],"call-creator":number},null],
				peer_app_version: undefined,
				peer_jid: number.split("@")[0]+"@s.whatsapp.net",
				peer_platform: undefined
		}
		    wavoip.handleIncomingSignalingReceipt(obj)
			console.log("handleIncomingSignalingReceipt");
        }else{
			console.log(json)
		}
		
 })

function b64toarray(base64) {
    var binary_string = atob(base64);
    var len = binary_string.length;
    var bytes = new Uint8Array(len);
    for (var i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
    }
    var array = Array.from(bytes)
    return array
}

function array2b64(array) {
	var array = Uint8Array.from(array)
	var bytes = []
    for (var i = 0; i < array.length; i++) {
		bytes[i]=String.fromCharCode(array[i])
    }
	bytes=bytes.join("")
	return btoa(bytes)
}
function generate_tag(){
	var e = new Uint8Array(8);
e = crypto.randomFillSync(e)
var n = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 65, 66, 67, 68, 69, 70]
 for (var t = new Array(16), r = 0, a = 0; r < e.length; r++,
                a += 2) {
                    var i = e[r];
                    t[a] = n[i >> 4],
                    t[a + 1] = n[15 & i]
                }
 return "3EB0" + String.fromCharCode.apply(String, t);
}
